# 텍사스 홀덤 3D: 상세 작업 흐름 및 리팩토링 보고서 (2026-02-19) 🚀

본 문서는 최근 진행된 3D 씬의 구조적 개선, 성능 최적화, 그리고 리팩토링 과정에서 발생한 문제들과 이를 극복하기 위해 도입한 전략(세이프 모드 등)을 상세히 기록한 보고서입니다.

---

## 1. 성능 이슈 진단 및 해결 (2026-02-18 작업) 🔋

어제 코드 전수 조사를 통해 발견된 심각한 성능 저하 요인들을 모두 해결했습니다.

### ⚠️ 메모리 누수 및 VRAM 관리 (Critical)
*   **문제**: 카드의 텍스처와 칩의 재질(Material)을 생성할 때 `clone()`을 사용했으나, 컴포넌트가 사라질 때 이를 메모리에서 해제하는 `dispose()` 로직이 누락되어 게임을 오래 켤수록 VRAM 점유율이 무한히 상승하는 문제가 있었습니다.
*   **해결**: `Card3D.tsx` 및 `InteractiveChip3D.tsx`에 `useEffect` Cleanup 함수를 도입하여, 소멸 시점에 모든 지오메트리, 텍스처, 재질을 명시적으로 파괴하도록 수정했습니다.

### ⚠️ GC(가비지 컬렉터) 부하 및 프레임 드랍 (High)
*   **문제**: `useFrame`은 초당 60~120회 실행되는 렌더 루프입니다. 이 내부에서 매 프레임마다 `new THREE.Vector3()` 같은 객체들을 수없이 생성하면서 메모리 쓰레기가 발생했고, 이로 인해 프레임이 툭툭 끊기는 현상이 발생했습니다.
*   **해결**: 루프 외부에서 `useMemo`를 통해 객체를 딱 한 번만 미리 생성(Pool)해두고, 루프 내에서는 값만 갱신하여 재사용하는 패턴을 적용했습니다. 결과적으로 GC 부하를 제거하여 매끄러운 프레임을 확보했습니다.

---

## 2. 계층 구조 리팩토링 과정 (Safe Mode 도입) 🏗️

기존의 파편화된 구조를 유니티 스타일의 계층(Hierarchy) 구조로 옮기는 과정은 매우 도전적이었습니다.

### 🛑 리팩토링 중 발생한 난관
*   모든 물체가 절대 좌표(World Zero) 기반일 때는 계산이 단순했으나, 부모 그룹(`TableUnit`, `PlayerUnit`)을 생성하고 그 하위로 물체들을 옮기자마자 마우스 드래그 좌표, 물리 엔진의 충돌체 위치, 카드 딜링 궤적이 모두 어긋나는 문제가 발생했습니다.
*   잘못된 좌표 계산으로 인해 물체가 씬 밖으로 튕겨나가는 등의 크리티컬한 버그가 빈번했습니다.

### 🛡️ '세이프 모드(Safe Mode)' 전략 도입
리팩토링의 안정성을 확보하기 위해 **"절대 좌표 보존 모드(세이프 모드)"** 개념을 도입하여 단계별로 진행했습니다.

1.  **기존 로직 보존 (Step 0)**: 새로운 계층 구조를 만들되, 모든 계산식은 여전히 월드 좌표계를 기준으로 동작하도록 `getWorldPosition` 등을 사용하여 "안전 장치"를 걸어두었습니다.
2.  **계층별 순차 전환 (Layer-by-Layer)**:
    - **1단계 (TableUnit)**: 테이블과 조명을 먼저 묶고, 좌표 오프셋을 `-3.0`으로 정렬하여 고정했습니다.
    - **2단계 (PlayerUnit)**: 플레이어 유닛(`z=3.5`)을 생성하고 카드/칩의 부모 자식 관계를 설정했습니다.
    - **3단계 (Local Logic)**: 안전 장치(월드 좌표 기반 계산)를 하나씩 제거하며, 부모 대비 상대 좌표(Local)로 인터콤포넌트 통신을 전환했습니다.
3.  **최종 검증**: 각 단계마다 물리 엔진(`Rapier`)이 부모의 변형에 영향받지 않고 정확한 충돌체를 생성하는지 디버그 모드로 교차 검증하며 진행했습니다.

---

## 3. 현재 씬 구조 요약 (Final State) 🏛️

리팩토링이 완료된 현재, 프로젝트는 매우 견고한 구조를 갖추고 있습니다.

*   **`TableUnit` [z = -3]**: 테이블, 커뮤니티 보드, 카드 덱, 조명이 하나의 엔티티로 관리됩니다.
*   **`PlayerUnit` [z = 3.5]**: 플레이어의 손패와 칩 트레이가 관리됩니다.
*   **통합 물리 월드**: 파편화되었던 `<Physics>` 컨텍스트를 하나로 통합하여 카드가 테이블을 뚫는 등의 물리 오류를 차단했습니다.
*   **디버그 시스템**: 실시간으로 물리 충돌 박스를 시각화할 수 있는 `isDebug` 토글 기능을 탑재하여 향후 개발 편의성을 높였습니다.

이제 씬의 위치를 옮기거나 카메라 뷰를 변경하더라도 하위 오브젝트들이 논리적으로 함께 움직이며, 성능적으로도 매우 최적화된 상태를 유지하고 있습니다.

---
**작성자**: Antigravity AI  
**대상 경로**: [Project Document/2026-02-19_상세_작업_흐름_및_리팩토링_보고서.md](file:///c:/Users/SAYOON/Documents/holdem-three-project/Project%20Document/2026-02-19_%EC%83%81%EC%84%B8_%EC%9E%91%EC%97%85_%ED%9D%90%EB%A6%84_%EB%B0%8F_%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81_%EB%B3%B4%EA%B3%A0%EC%84%9C.md)

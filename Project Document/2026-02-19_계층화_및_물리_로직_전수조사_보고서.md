# 2026-02-19 계층화 및 물리 로직 전수조사 보고서

## 1. 개요
멀티플레이어(좌석 추가) 구현 과정에서 발견된 `InteractiveHand3D`의 물리 로직 오류를 계기로, 프로젝트 전반의 계층 구조 및 참조 로직에 대한 전수조사를 실시함. 조사 결과, 리액트의 상태 변화에 따른 컴포넌트 재렌더링과 Three.js/Rapier의 물리 참조 방식 사이의 결합도 문제(Ref-Dependency Trap)가 주요 결함으로 확인됨.

---

## 2. 주요 결함 분석

### 🔍 결함 A: Ref 참조 유실 (Ref-Dependency Trap)
*   **파일**: [InteractiveHand3D.tsx](file:///c:/Users/SAYOON/Documents/holdem-three-project/src/components/Card/InteractiveHand3D.tsx)
*   **현상**: 폴드(Fold) 시 카드가 날아가지 않고 바닥으로 수직 낙하함.
*   **원인**: 
    - `isFolded` 상태가 `true`가 되는 순간, 컴포넌트의 `return` 문이 교체됨.
    - 기존 `groupRef`가 잡고 있던 그룹이 언마운트(Unmount)되면서 `Ref`가 `null`이 됨.
    - `useFrame` 내부의 물리 Impulse 계산 로직이 `groupRef.current`의 존재 여부를 체크하므로, 참조가 사라진 시점에서 힘이 가해지지 않음.
*   **해결 방안**: 상태에 따라 `return` 전체를 바꾸지 말고, 부모 그룹 구조는 유지한 채 내부 자식 노드만 상태에 따라 교체하여 `Ref`의 안정성을 확보해야 함.

### 🔍 결함 B: 좌표계 강결합 (Coordinate Coupling)
*   **파일**: [Scene3D.tsx](file:///c:/Users/SAYOON/Documents/holdem-three-project/src/components/Scene3D/Scene3D.tsx) (CameraController)
*   **현상**: 카메라의 LookAt 대상이 특정 좌표(`0, 0, -3`)로 고정되어 있음.
*   **위험성**: 향후 테이블의 위치가 미세하게 조정되거나 여러 개의 테이블이 생길 경우 카메라 로직을 일일이 수정해야 함.
*   **해결 방안**: 테이블 컴포넌트(`Table3D`)에 `Ref`를 달거나 명시적인 `Anchor`를 두어, 카메라가 동적으로 대상을 추적하도록 수정.

### 🔍 결함 C: 계층적 책임 분리 미흡 (Logic Leakage)
*   **파일**: [PlayerSeat3D.tsx](file:///c:/Users/SAYOON/Documents/holdem-three-project/src/components/Player/PlayerSeat3D.tsx), `Scene3D.tsx`
*   **현상**: `Scene3D`가 칩의 개별 레이아웃(`chipLayout`) 정보를 계산하고 있음.
*   **원항**: 플레이어 좌석에 종속된 칩들의 배치는 각 시트(`PlayerSeat3D`)가 결정해야 하며, 최상위 씬은 게임 상태(금액 등)만 전달해야 함.
*   **해결 방안**: 칩 생성 및 배치 로직을 `PlayerSeat3D` 내부로 완전히 캡슐화.

---

## 3. 리팩토링 계획
1.  **Stable Ref 구조 도입**: `InteractiveHand3D`의 JSX 구조를 개선하여 언마운트 시 참조 유실 방지.
2.  **Anchor 기반 카메라**: 카메라가 좌표가 아닌 `Object3D`를 추적하게 변경.
3.  **완전한 위임(Delegation)**: `Scene3D` -> `PlayerSeat3D` -> `InteractiveChip3D`로 이어지는 데이터 흐름 최적화.
---

## 4. 리팩토링 결과 (Action Taken)
1.  **Stable Ref 구조 (InteractiveHand3D)**: JSX를 `isFolded` 플래그로 완전히 분기하지 않고, 공통 부모 그룹(`groupRef`) 아래에서 자식만 교체하도록 수정하여 물리 엔진과의 좌표 참조 안정성 확보.
2.  **Anchor 기반 카메라 (Scene3D)**: `Table3D`에 `forwardRef`를 적용하고 `CameraController`가 테이블의 월드 위치를 동적으로 추적하도록 변경. 하드코딩된 `0, 0, -3` 제거.
3.  **좌표 위임 구조 강화 (InteractiveChip3D)**: 칩이 `initialWorldPos`를 주입받는 대신, 부모 시트의 트랜스폼을 통해 `localToWorld` 연산으로 자신의 리셋 위치를 실시간 계산하도록 변경.

---
**최종 확인**: 모든 인터랙션이 부모-자식 계층을 따르며, 부모의 위치가 바뀌어도 추가 코드 수정 없이 동작함.
---
**조사자**: Antigravity (AI Assistant)  
**날짜**: 2026-02-19
